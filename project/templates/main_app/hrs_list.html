<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .table.tasks-list
            width: 1%;
            white-space: nowrap;
            text-align: center;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }

        .table-responsive-container {
            overflow-x: auto;
            margin-bottom: 0;
        }

        .table.tasks-list td:nth-child(6) { min-width: 190px; }

        .btn-custom {
            display: inline-block;
            padding: 4px 8px;
            font-size: 13px;
            border-radius: 4px;
            color: #fff;
            text-decoration: none;
            margin-right: 4px;
        }
        .btn-edit { background-color: #007bff; }
        .btn-delete { background-color: #dc3545; }
        .btn-custom:hover { opacity: 0.85; }

        th.server-sort { cursor: pointer; user-select: none; position: relative; }
        th.server-sort .sort-indicator { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.7em; opacity: 0.7; }
    </style>
    <style id="dynamic-cols-style"></style>
</head>
<body>

<div class="container-fluid mt-3 d-flex flex-column h-100">

    <div class="datatable-header flex-shrink-0 dt-no-pagination-header mb-3 d-flex justify-content-end ms-2 mb-3">
        <div class="form-control-feedback form-control-feedback-end">
            <div class="dropdown d-flex align-items-center ms-3">
                <button class="btn btn-outline-secondary dropdown-toggle mb-3 me-2" type="button" id="viewButton" data-bs-toggle="dropdown" aria-expanded="false">
                    View
                </button>
                <ul id="view-dropdown" class="dropdown-menu" aria-labelledby="viewButton">
                    <li><button class="dropdown-item" id="selectAllCols">Select All</button></li>
                    <li><button class="dropdown-item" id="deselectAllCols">Deselect All</button></li>
                    <li><hr class="dropdown-divider"></li>

                    <li class="dropdown-item d-flex align-items-center py-2">
                        <input type="checkbox" id="showAvatar" class="form-check-input me-2 col-toggle" data-target="col-avatar" checked>
                        <label for="showAvatar" class="form-check-label mb-0 w-100">Profile</label>
                    </li>
                    <li class="dropdown-item d-flex align-items-center py-2">
                        <input type="checkbox" id="showName" class="form-check-input me-2 col-toggle" data-target="col-name" checked>
                        <label for="showName" class="form-check-label mb-0 w-100">Name</label>
                    </li>
                    <li class="dropdown-item d-flex align-items-center py-2">
                        <input type="checkbox" id="showEmail" class="form-check-input me-2 col-toggle" data-target="col-email" checked>
                        <label for="showEmail" class="form-check-label mb-0 w-100">Email</label>
                    </li>
                    <li class="dropdown-item d-flex align-items-center py-2">
                        <input type="checkbox" id="showPhone" class="form-check-input me-2 col-toggle" data-target="col-phone" checked>
                        <label for="showPhone" class="form-check-label mb-0 w-100">Phone</label>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <div class="table-responsive-container flex-grow-1">
        <table class="table tasks-list mb-0">
            <thead>
                <tr>
                    <th class="col-avatar">Profile</th>

                    <th class="server-sort col-name" data-sort="name">
                        Name
                        <span class="sort-indicator">
                            {% if current_sort == 'name' %}{% if current_direction == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                        </span>
                    </th>

                    <th class="server-sort col-email" data-sort="email">
                        Email
                        <span class="sort-indicator">
                            {% if current_sort == 'email' %}{% if current_direction == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                        </span>
                    </th>

                    <th class="server-sort col-phone" data-sort="phone">
                        Phone
                        <span class="sort-indicator">
                            {% if current_sort == 'phone' %}{% if current_direction == 'asc' %}▲{% else %}▼{% endif %}{% endif %}
                        </span>
                    </th>

                    <th style="width: 150px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in page_obj %}
                    <tr>
                      <td class="col-avatar">
                        {% if item.avatar %}
                          <img src="{{ item.avatar.url }}" alt="Profile photo"
                               style="width:60px; height:60px; object-fit:cover; border-radius:50%;">
                        {% else %}
                          -
                        {% endif %}
                      </td>

                      <td class="col-name">
                          <a href="{% url 'hr_profile' name=item.name %}">
                              {{ item.user.first_name }} {{ item.user.last_name }}
                          </a>
                      </td>

                      <td class="col-email">{{ item.user.email|default:"—" }}</td>
                      <td class="col-phone">{{ item.pretty_phone|default:"—" }}</td>

                      <td>
                        <a href="{% url 'hr_edit' name=item.name %}" class="btn-custom btn-edit">
                            <i class="ph-pencil"></i>
                        </a>
                        <form method="post" action="{% url 'hr_delete' item.pk %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn-custom btn-delete"
                                    onclick="return confirm('Delete HR?');"
                                    style="border:none; cursor:pointer;">
                                <i class="ph-trash"></i>
                            </button>
                        </form>
                      </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="6" class="text-center">No records found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
    <div class="mt-auto mt-3 mb-2">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1" aria-label="First">&laquo;&laquo;</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">&laquo;</a>
                    </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active" aria-current="page">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">&raquo;</a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">&raquo;&raquo;</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const colToggles = document.querySelectorAll('.col-toggle');
        const styleTag = document.getElementById('dynamic-cols-style');
        const selectAllBtn = document.getElementById('selectAllCols');
        const deselectAllBtn = document.getElementById('deselectAllCols');

        function applyColumnVisibility() {
            let css = "";
            colToggles.forEach(toggle => {
                const targetClass = toggle.getAttribute('data-target');
                const isVisible = toggle.checked;
                localStorage.setItem('hr_col_vis_' + targetClass, isVisible);
                if (!isVisible) css += `.${targetClass} { display: none !important; } `;
            });
            styleTag.innerHTML = css;
        }

        colToggles.forEach(toggle => {
            const targetClass = toggle.getAttribute('data-target');
            const saved = localStorage.getItem('hr_col_vis_' + targetClass);
            if (saved !== null) toggle.checked = (saved === 'true');
            toggle.addEventListener('change', applyColumnVisibility);
        });
        applyColumnVisibility();

        if(selectAllBtn) selectAllBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); colToggles.forEach(t => t.checked = true); applyColumnVisibility(); };
        if(deselectAllBtn) deselectAllBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); colToggles.forEach(t => t.checked = false); applyColumnVisibility(); };
        const viewDropdown = document.getElementById('view-dropdown');
        if(viewDropdown) viewDropdown.onclick = (e) => e.stopPropagation();

        const urlParams = new URLSearchParams(window.location.search);
        const currentSort = urlParams.get('sort') || 'name';
        const currentDir = urlParams.get('direction') || 'asc';

        const headers = document.querySelectorAll('.server-sort');
        headers.forEach(th => {
            th.addEventListener('click', (e) => {
                e.stopImmediatePropagation();
                e.preventDefault();

                const sortField = th.getAttribute('data-sort');
                let newDir = 'asc';

                if (sortField === currentSort) {
                    newDir = (currentDir === 'asc') ? 'desc' : 'asc';
                }

                urlParams.set('sort', sortField);
                urlParams.set('direction', newDir);
                urlParams.set('page', 1);

                window.location.search = urlParams.toString();
            });
        });

        const pageLinks = document.querySelectorAll('.pagination .page-link');
        pageLinks.forEach(link => {
            const href = link.getAttribute('href');
            if (href && href.includes('?')) {
                const linkUrl = new URL(link.href);

                if (!linkUrl.searchParams.has('sort')) {
                    linkUrl.searchParams.set('sort', currentSort);
                    linkUrl.searchParams.set('direction', currentDir);
                }

                urlParams.forEach((value, key) => {
                    if (!linkUrl.searchParams.has(key) && key !== 'page') {
                        linkUrl.searchParams.set(key, value);
                    }
                });

                link.setAttribute('href', linkUrl.search);
            }
        });
    });
</script>
</body>
</html>